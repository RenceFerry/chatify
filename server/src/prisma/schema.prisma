generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.

enum ConvoType {
  PRIVATE
  GROUP
}

model users {
  created_at DateTime @default(now()) @db.Timestamptz(6)
  username   String
  password   String?
  image      String?
  email      String   @unique
  id         String   @id @unique @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  conversations  ConversationParticipant[]
  messages       Message[]
}

model Conversation {
  id         String   @id @unique @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  name       String
  image      String?
  type       ConvoType  @default(PRIVATE)
  lastMessageAt DateTime @default(now())

  // Relations
  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

model ConversationParticipant {
  id              String  @id @unique @default(dbgenerated("gen_random_uuid()"))  @db.Uuid
  userId          String  @db.Uuid
  conversationId  String  @db.Uuid
  lastReadAt      DateTime?
  unreadCount     Int     @default(0)

  // Relations
  user            users          @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation    Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([userId, conversationId])
  @@index([conversationId])
  @@map("conversation_participants")
}

model Message {
  id             String   @id @unique @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  content        String
  createdAt      DateTime @default(now()) @db.Timestamptz(6)

  senderId       String  @db.Uuid
  conversationId String  @db.Uuid

  // Relations
  sender          users          @relation(fields: [senderId], references: [id], onDelete: Cascade)
  conversation    Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}